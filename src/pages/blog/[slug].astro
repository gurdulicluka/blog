---
// NOTE: BLOG POST PAGE //

import { getCollection, CollectionEntry } from "astro:content";
import { sortByDate, formatDate } from "../../js/utils";
// components
import MainLayout from "../../layouts/MainLayout.astro";
import CategoryBadge from "../../components/CategoryBadge.astro";
// generate props and params for each path
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const formattedPosts = sortByDate(allPosts);
  return formattedPosts.map((post) => ({
    params: { slug: post.slug },
    props: {
      post,
    },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props as Props;
const { title, description, category, image, author, date } = post.data;
const { Content } = await post.render();
const allPosts = await getCollection("blog");
const formattedPosts = sortByDate(allPosts);
const relatedPosts = formattedPosts
  .filter(
    (post) =>
      post.data.category.toLowerCase() === category.toLowerCase() &&
      post.data.title !== title
  )
  .slice(0, 3);
---

<MainLayout title={title} description={description} image={image}>
  <div class="mt-10">
    <div
      class="container flex flex-col justify-between gap-6 text-center sm:flex-row sm:items-end sm:gap-[10%] sm:text-left"
    >
      <div class="flex-1">
        <CategoryBadge category={category} />
        <h1
          class="mt-5 font-danley text-2xl sm:text-3xl lg:text-4xl 2xl:text-5xl"
        >
          {title}
        </h1>
      </div>
      <small class="flex justify-between text-sm sm:flex-col">
        <span class="font-semibold underline">{author}</span>
        <span>{formatDate(date)}</span>
      </small>
    </div>
    <img
      class="mb-20 mt-5 h-[50vh] min-h-[450px] w-full object-cover object-center lg:container sm:h-[700px] lg:h-[800px] lg:object-top"
      src={image.src}
      alt={image.alt}
    />
  </div>
  <article
    class="container mb-10 flex flex-col border-b-2 border-gray-200 lg:flex-row"
  >
    <div
      class="lg: prose flex-1 px-6 pb-8 prose-h3:text-2xl xl:max-w-none xl:prose-p:text-lg"
    >
      <Content />
    </div>
    <aside class="border-gray-200 lg:w-[35%] xl:ml-10 xl:border-l-2 xl:pl-6">
      <div class="top-6 xl:sticky">
        <h2 class="bg-pink-200 font-danley text-3xl">Related Posts</h2>
      </div>
    </aside>
  </article>
</MainLayout>
