---
import { getCollection, CollectionEntry } from "astro:content";
import { sortByDate } from "../../js/utils";

// components
import MainLayout from "../../layouts/MainLayout.astro";
import AuthorBadge from "../../components/AuthorBadge.astro";
import SocialShare from "../../components/post/SocialShare.astro";
import RelatedPosts from "../../components/post/RelatedPosts.astro";
import Sidebar from "../../components/post/Sidebar.astro";
import ReadNext from "../../components/post/ReadNext.astro";

// generate props and params for each path
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const formattedPosts = sortByDate(allPosts);
  return formattedPosts.map((post) => ({
    params: { slug: post.slug },
    props: {
      post,
    },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const allPosts = await getCollection("blog");
const formattedPosts: CollectionEntry<"blog">[] = sortByDate(allPosts);
const { post } = Astro.props as Props;
const { title, description, category, image, author, date } = post.data;
const { Content } = await post.render();
---

<MainLayout title={title} description={description} image={image}>
  <div class="lg:container">
    <img
      fetchpriority="high"
      src={image.src}
      alt={image.alt}
      class="w-full md:h-[445px] h-[375px] animate__animated animate__fadeIn aspect-video lg:rounded-b-md lg:h-[600px] max-h-[55vh] object-cover object-center"
    />
    <div
      class="sm:p-8 p-5 flex flex-col rounded-b-lg xl:flex-row sm:-my-[100px] -my-[70px] relative shadow-lg z-20 rounded-t-2xl sm:w-[95%] w-[98%] mx-auto bg-base-300"
    >
      <section class="xl:pr-8 flex-1">
        <header class="mb-10">
          <div class="flex justify-between items-start">
            <AuthorBadge author={author} date={date} />
            <SocialShare title={title} />
          </div>
          <hgroup class="mt-6">
            <h1 class="text-4xl font-bold mb-4">{title}</h1>
            <p class="text-lg md:max-w-[85%] font-semibold">{description}</p>
          </hgroup>
        </header>
        <article
          class="prose xl:prose-lg prose-headings:text-base-content max-w-none"
        >
          <Content />
        </article>
        <ReadNext posts={formattedPosts} currentPost={post} />
      </section>
      <Sidebar posts={formattedPosts} />
    </div>
  </div>
  <RelatedPosts posts={formattedPosts} category={category} />
</MainLayout>
