---
import { getCollection, CollectionEntry } from "astro:content";
import { sortByDate } from "../../js/utils";

// components
import MainLayout from "../../layouts/MainLayout.astro";
import CategoryBadge from "../../components/CategoryBadge.astro";
import LatestPost from "../../components/post/LatestPost.astro";
import NewsletterCard from "../../components/post/NewsletterCard.astro";

// generate props and params for each path
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const formattedPosts = sortByDate(allPosts);
  return formattedPosts.map((post) => ({
    params: { slug: post.slug },
    props: {
      post,
    },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const allPosts = await getCollection("blog");
const formattedPosts = sortByDate(allPosts);
const { post } = Astro.props as Props;
const { title, description, category, image } = post.data;
const { Content } = await post.render();
const latestPosts = formattedPosts.slice(0, 3);
const relatedPosts = formattedPosts
  .filter(
    (post) =>
      post.data.category.toLowerCase() === category.toLowerCase() &&
      post.data.title !== title
  )
  .slice(0, 4);
---

<MainLayout title={title} description={description} image={image}>
  <div class="lg:container">
    <img
      src={image.src}
      alt={image.alt}
      class="w-full md:h-[445px] h-[375px] lg:rounded-b-md lg:h-[600px] brightness-[0.6] object-cover object-center"
    />
    <!-- BELOW IMAGE CONTENT -->
    <section
      class="p-6 flex flex-col xl:flex-row sm:-mt-[calc(0.20*435px)] -mt-[calc(0.20*435px)] relative shadow-md rounded-t-2xl rounded-b-lg w-[95%] mx-auto bg-base-300"
    >
      <!-- BLOG POST -->
      <div
        class="flex-1 prose xl:prose-lg prose-headings:text-base-content max-w-none"
      >
        <Content />
      </div>
      <!-- SIDEBAR -->
      <aside class="w-[30%] pl-7 hidden xl:block">
        <div class="sticky top-[70px]">
          <NewsletterCard />
          <h3 class="text-lg font-bold mb-3">Latest Posts</h3>
          <div class="flex flex-col gap-5">
            {
              latestPosts.map((post) => {
                return <LatestPost post={post} />;
              })
            }
          </div>
        </div>
      </aside>
      <!-- SIDEBAR -->
    </section>
  </div>
</MainLayout>
